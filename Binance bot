import os
import logging
import time
import numpy as np
import pandas as pd
import threading
import asyncio
import websockets
import requests
import torch
import torch.nn as nn
import torch.optim as optim
from dotenv import load_dotenv
from binance.client import Client
from kucoin.client import Client as KucoinClient
from okx import MarketData, Trade
from web3 import Web3
from google.colab import auth
from googleapiclient.discovery import build
from googleapiclient.http import MediaFileUpload

# ğŸ“Œ API AnahtarlarÄ±nÄ± GÃ¼venli Åekilde YÃ¼kle
load_dotenv()
BINANCE_API_KEY = os.getenv("BINANCE_API_KEY")
BINANCE_API_SECRET = os.getenv("BINANCE_API_SECRET")
KUCOIN_API_KEY = os.getenv("KUCOIN_API_KEY")
KUCOIN_API_SECRET = os.getenv("KUCOIN_API_SECRET")
OKX_API_KEY = os.getenv("OKX_API_KEY")
OKX_API_SECRET = os.getenv("OKX_API_SECRET")
ALCHEMY_ETH_API_KEY = os.getenv("ALCHEMY_ETH_API_KEY")
INFURA_API_KEY = os.getenv("INFURA_API_KEY")
THE_GRAPH_API_URL = os.getenv("THE_GRAPH_API_URL")
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
TELEGRAM_CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")

# ğŸ“Œ Binance, KuCoin ve OKX BaÄŸlantÄ±larÄ±
binance_client = Client(BINANCE_API_KEY, BINANCE_API_SECRET)
kucoin_client = KucoinClient(KUCOIN_API_KEY, KUCOIN_API_SECRET)
okx_market = MarketData(OKX_API_KEY, OKX_API_SECRET)
okx_trade = Trade(OKX_API_KEY, OKX_API_SECRET)

# ğŸ“Œ Blockchain API BaÄŸlantÄ±larÄ±
w3_alchemy = Web3(Web3.HTTPProvider(f"https://eth-mainnet.g.alchemy.com/v2/{ALCHEMY_ETH_API_KEY}"))
w3_infura = Web3(Web3.HTTPProvider(f"https://mainnet.infura.io/v3/{INFURA_API_KEY}"))

# ğŸ“Œ Google Drive Kimlik DoÄŸrulama
auth.authenticate_user()
drive_service = build('drive', 'v3')

# ğŸ“Œ API Failover MekanizmasÄ± (Alchemy & Infura)
def get_blockchain_data():
    if w3_alchemy.is_connected():
        logging.info("âœ… Alchemy API'den blok verisi Ã§ekiliyor...")
        return w3_alchemy.eth.get_block("latest")
    elif w3_infura.is_connected():
        logging.info("ğŸ”„ Alchemy API baÅŸarÄ±sÄ±z oldu, Infura API'den blok verisi Ã§ekiliyor...")
        return w3_infura.eth.get_block("latest")
    else:
        logging.error("âŒ Hem Alchemy hem de Infura API baÅŸarÄ±sÄ±z oldu!")
        return None

# ğŸ“Œ The Graph API ile On-Chain Analiz
def get_graph_data():
    query = """
    {
      transfers(first: 5) {
        id
        from
        to
        value
      }
    }
    """
    response = requests.post(THE_GRAPH_API_URL, json={"query": query})
    if response.status_code == 200:
        return response.json()
    else:
        logging.error(f"âŒ The Graph API baÅŸarÄ±sÄ±z! {response.text}")
        return None

# ğŸ“Œ AI Modeli (LSTM)
class LSTMPredictor(nn.Module):
    def __init__(self, input_size=1, hidden_layer_size=50, output_size=1):
        super().__init__()
        self.hidden_layer_size = hidden_layer_size
        self.lstm = nn.LSTM(input_size, hidden_layer_size, batch_first=True)
        self.linear = nn.Linear(hidden_layer_size, output_size)

    def forward(self, input_seq):
        lstm_out, _ = self.lstm(input_seq)
        predictions = self.linear(lstm_out[:, -1])
        return predictions

# ğŸ“Œ AI Modelini EÄŸitme
def train_ai_model():
    data = pd.read_csv("market_data.csv")
    X = torch.tensor(data['feature'].values, dtype=torch.float32)
    y = torch.tensor(data['target'].values, dtype=torch.float32)

    model = LSTMPredictor()
    optimizer = optim.Adam(model.parameters(), lr=0.001)
    loss_function = nn.MSELoss()

    for epoch in range(10):
        optimizer.zero_grad()
        output = model(X)
        loss = loss_function(output, y)
        loss.backward()
        optimizer.step()

    torch.save(model.state_dict(), "ai_model.pth")
    logging.info("âœ… AI Modeli GÃ¼ncellendi!")
    return model

# ğŸ“Œ WebSocket BaÄŸlantÄ±sÄ± BaÅŸlatma
async def websocket_listener(exchange, symbol):
    uris = {
        "binance": f"wss://stream.binance.com:9443/ws/{symbol.lower()}@trade",
        "kucoin": f"wss://ws-api.kucoin.com/endpoint",
        "okx": f"wss://ws.okx.com:8443/ws/v5/public"
    }
    uri = uris.get(exchange, "")

    while True:
        try:
            async with websockets.connect(uri) as websocket:
                while True:
                    message = await websocket.recv()
                    print(f"ğŸ“¡ {exchange.upper()} | {symbol}: {message}")
        except Exception as e:
            logging.error(f"WebSocket baÄŸlantÄ±sÄ±nda hata: {e}. 5 saniye sonra yeniden baÄŸlanÄ±lÄ±yor...")
            await asyncio.sleep(5)

# ğŸ“Œ Telegram UyarÄ± Sistemi
def send_telegram_alert(message):
    url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
    data = {"chat_id": TELEGRAM_CHAT_ID, "text": message}
    try:
        requests.post(url, data=data)
    except Exception as e:
        logging.error(f"Telegram uyarÄ±sÄ± gÃ¶nderilirken hata: {e}")

# ğŸ“Œ Google Drive'a Veri Kaydetme
def save_to_drive(content, filename="trading_data.txt"):
    filepath = f"/content/{filename}"
    with open(filepath, "w") as file:
        file.write(content)
    file_metadata = {'name': filename, 'parents': ['binance pump']}
    media = MediaFileUpload(filepath, mimetype='text/plain')
    file = drive_service.files().create(body=file_metadata, media_body=media, fields='id').execute()
    logging.info(f"ğŸ“ {filename} Google Drive'a kaydedildi.")

# ğŸ“Œ Ã‡oklu Ä°ÅŸlem AÃ§ma (KuCoin & OKX)
def send_order(symbol, side, quantity, price, exchange):
    api_url = "https://api.kucoin.com/api/v1/orders" if exchange == "kucoin" else "https://www.okx.com/api/v5/trade/order"
    order_data = {"symbol": symbol, "side": side, "quantity": quantity, "price": price}
    response = requests.post(api_url, json=order_data)
    return response.json()

# ğŸ“Œ Ana Ã‡alÄ±ÅŸtÄ±rma
if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)

    # WebSocket BaÄŸlantÄ±larÄ±
    symbols = ["BTCUSDT", "ETHUSDT"]
    for symbol in symbols:
        threading.Thread(target=lambda: asyncio.run(websocket_listener("binance", symbol)), daemon=True).start()
        threading.Thread(target=lambda: asyncio.run(websocket_listener("kucoin", symbol)), daemon=True).start()
        threading.Thread(target=lambda: asyncio.run(websocket_listener("okx", symbol)), daemon=True).start()

    # Blockchain Verisi Ã‡ekme & The Graph API KullanÄ±mÄ±
    while True:
        block_data = get_blockchain_data()
        graph_data = get_graph_data()
        
        if block_data:
            logging.info(f"âœ… Blok No: {block_data['number']}, Ä°ÅŸlemler: {len(block_data['transactions'])}")
        
        if graph_data:
            logging.info(f"âœ… The Graph API Verileri: {graph_data}")

        time.sleep(60)  # Her dakika veri Ã§ek
